<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama LLM Assist</title>    
	<link rel="stylesheet" href="styles/uikit.min.css" />
	<link rel="stylesheet" href="styles/app.css?v=1.027" />	   
</head>
<body>
<div id="vue-app" class="llm-container"> 
	<div class="llm-header"> 
		<div class="uk-grid uk-grid-collapse"> 
			<div class="uk-width-3-4">
				<img src="images/cpu_icon.svg?v=1.01" />
				<select class="llm-model" v-model="llm" title="AI Model">  
					<option v-for="option in options" >
						{{ option }}
					</option>
				</select>  
			</div>
			<div class="uk-width-1-4 uk-text-right">				  
				<button class="llm-btn-chat" title="New chat" v-on:click="reset"><img src="images/chat_icon.svg" /> </button> 
			</div>
		</div>			 
	</div>
	<div id="llm-dialog" class="llm-chat uk-width-xlarge-1-2"></div> 
	<div class="llm-footer">		 
		<div class="llm-compose uk-width-xlarge-1-2 uk-align-center">
			<div class="uk-width-1-1 uk-flex uk-flex-top llm-textarea">			    
				<textarea id="enquire" v-model="enquire" placeholder="write something"> </textarea> 
			
				<button id="send" class="llm-btn" v-show="!state" v-on:click="send" title="Send"><img src="images/upload_icon.svg" alt="Pause" /></button>
				<button id="pause" class="llm-btn" v-show="state" v-on:click="pause" title="Pause"><img src="images/pause_icon.svg?v=1.02" alt="Pause" /></button> 
			</div> 			
			<div class="llm-tools">
				<input type="checkbox" id="switch" role="switch" v-model="looping" />
				<label for="switch" class="btn-toggle"><span>Tools</span></label>
			</div>
		</div> 
		<div class="uk-width-1-1 ">LLM Assist ver 0.21 copyright by Stephen Yeung</div>	
	</div>    
</div>  
<script src="scripts/app.js"></script> 
<script src="scripts/vue.min.js"></script>  
<script type="module"> 
import { ChatClient } from './scripts/chatclient.js?v=1.023';

var app, textbox;

const host = 'http://localhost:11434';  
const tt_s = 1000 * 1000 * 1000;

const availableFunc = [addTwoNumbersTool, subtractTwoNumbersTool]; 

const func_list = {
	addTwoNumbers: (args) => { return args.a + args.b; },
	subtractTwoNumbers: (args) => { return args.a - args.b; }
}; 
 
const client = new ChatClient(host);

// chat start 
client.onBegin = async () => {
	app.enquire = ""; 
}

// chat response result 
client.onResult = async (str) => {
	let dialog = document.getElementById("llm-dialog").lastChild;
	
	textbox = dialog.querySelector('p');  
	textbox.innerHTML = "";	  
}

//char message receive
client.onReceive = async (str) => {
	textbox.textContent += str;	 
} 

//char end
client.onEnd = async (response) => { 
	console.log(response);
	
	if (response.message.tool_calls) { 
	
        // Process tool calls from the response
        for (const tool of response.message.tool_calls) {
            let func = tool.function;
			
			const callFunc = func_list[func.name];	 
            if (callFunc) {
			    textbox.innerHTML += 'The result is: ' + callFunc(func.arguments); 
            } else {
                textbox.innerHTML += 'Function ' + func.name + ' not found';
            }
        }
	}

	//show tokens per second
	let dt = response.eval_duration / tt_s;
	let token = response.eval_count / response.eval_duration * tt_s;
	
	textbox.innerHTML += "<span>" + token.toFixed(2) + " t/s, " +  dt.toFixed(2) + 's </span>'; 
}

//chat clear
client.onDispose = async () => {
	let d = document.getElementById("llm-dialog");		
	d.innerHTML = "";
} 
 

app = new Vue({
		el: '#vue-app',
		data: { options: [],  llm: "", enquire: "", state: false, looping: false },
		methods: {		
			send: async function () {
				if (this.state) return;
				if (this.llm == "" || this.enquire == "") {  
					return; 
				}
					
				this.state = true;	 
				
				//start chat
				let message = this.enquire;	 
				
				this.addText('', message, "llm-send");	
				this.addText(this.llm, '<img src="images/loading.svg" alt="thinking" />', "llm-received"); 
				  
				try { 
					//send message
					await client.Send(this.llm, message, !this.looping, availableFunc); 
				}
				catch(err) { 
					alert(err.message);	
				}
				
				this.state = false;	 
			},
			list: async function() {
				try {
					let list = await client.GetModels(); 
						
					list.forEach( item => {
						this.options.push(item); 
					});	 
				}
				catch(err) {
					alert(err.message);
				}							
			},
			addText: function(name, str, css) {
				var child = document.createElement("div");
				child.setAttribute('class', 'llm-message ' + css); 
				
				child.innerHTML = `<div>
									<b>${name}</b>
									<p>${str}</p> 
								</div>`; 
				
				let parent = document.getElementById("llm-dialog");	
				
				parent.appendChild(child);
			},
			pause: function() {
				client.Stop();
			},
			reset: function() {
				client.Reset();
			}
		}
	});
	
	app.list();	
</script>
</body>
</html>
